function $(n){return document.querySelector(n)}function $$(n){return document.querySelectorAll(n)}function renderBlock(n){n.forEach(function(n,t){var e=t+1;n.forEach(function(n,t){ctx.fillRect(n*block.width,e*block.height,block.width,block.height)})})}var isArrive,roadArr=[],openList=function(){var n=[];return{add:function(t){n.push(t)},count:function(){return n.length},minPoint:function(){return 1!==this.count()?(n.sort(compareF),n[0]):n[0]},removeAt:function(t){n.splice(t,1)},exists:function(t){for(i=0;i<n.length;i++)if(n[i].x==t.x&&n[i].y==t.y)return!0},foundPoint:function(n,t,e){},notFoundPoint:function(t,e,i){var o=!0,r=!0;if(wallBlockArr.forEach(function(n,t){n.forEach(function(n,e){n==i.x&&t+1==i.y&&(o=!1)})}),closeList.getCloseArr().forEach(function(n,t){n.x==i.x&&n.y==i.y&&(r=!1)}),r&&o){var a,c,l;c=10*(Math.abs(e.x-i.x)+Math.abs(e.y-i.y)),a=t.x===i.x||t.y===i.y?10:14,l=c+a,i.H=c,i.G=a,i.F=l,i.parents=t,n.push(i)}},get:function(n){closeList.getCloseArr().forEach(function(t,e){n.x===t.x&&n.y===t.y&&(n.parents=t.parents,isArrive=!0)})},look:function(){console.log(n)},init:function(){n.splice(0,n.length)}}}(),compareF=function(n,t){return n.F-t.F},closeList=function(){var n=[];return{add:function(t){n.push(t)},getCloseArr:function(){return n},init:function(){n.splice(0,n.length)}}}(),findPath=function(n,t){for(isArrive=!1,openList.add(n);!isArrive;){var e=openList.minPoint();openList.removeAt(0),closeList.add(e);var i=sAroundPoints(e);i.forEach(function(n,i){openList.exists(n)?openList.foundPoint(e,t,n):openList.notFoundPoint(e,t,n)}),openList.get(t)}foundPathRoad(t)},sAroundPoints=function(n){var t=n.x,e=n.y;return[{x:t-1,y:e},{x:t-1,y:e-1},{x:t-1,y:e+1},{x:t+1,y:e},{x:t+1,y:e-1},{x:t+1,y:e+1},{x:t,y:e-1},{x:t,y:e+1}]},foundPathRoad=function(n){return"parents"in n&&(roadArr.unshift(n),arguments.callee(n.parents)),roadArr},initFindPath=function(){roadArr.splice(0,roadArr.length),openList.init(),closeList.init()},eventUtil={addHandler:function(n,t,e){n.addEventListener?n.addEventListener(t,e,!1):n.attachEvent?n.attachEvent("on"+t,e):n["on"+t]=e},removeHandler:function(n,t,e){n.removeEventListener?n.removeEventListener(t,e,!1):n.detachEvent?n.detachEvent("on"+t,e):n["on"+t]=null}},canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");canvas.width=320,canvas.height=560,document.body.appendChild(canvas);var kingsMan={speed:256,x:180,y:20,sx:4,sy:0},endPoint={x:3,y:13},block={width:40,height:40},cooX=[[0,40],[40,80],[80,120],[120,160],[160,200],[200,240],[240,280],[280,320]],cooY=[[0,40],[40,80],[80,120],[120,160],[160,200],[200,240],[240,280],[280,320],[320,360],[360,400],[400,440],[440,480],[480,520],[520,560]],wallBlockArr=[],stageNum=0,targetBlock,isClickWall,isFinding=!1;eventUtil.addHandler($("canvas"),"click",function(n){isClickWall=!0,targetBlock=calTargetBlock(n.offsetX,n.offsetY),isClickWall&&!isFinding&&(isFinding=!0,findPath({x:kingsMan.sx,y:kingsMan.sy,flag:kingsMan.flag},targetBlock),renderMovePath())},!1);var calTargetBlock=function(n,t){var e,i,o={};return cooX.forEach(function(t,i){n>t[0]&&n<t[1]&&(e=i,o.x=e)}),cooY.forEach(function(n,e){t>n[0]&&t<n[1]&&(i=e,o.y=i)}),wallBlockArr.forEach(function(n,t){n.forEach(function(n,e){n==o.x&&t+1==o.y&&(isClickWall=!1)})}),o},reset=function(){wallBlockArr=createBlock(13,2),kingsMan.x=180,kingsMan.y=20,kingsMan.sx=4,kingsMan.sy=0},createBlock=function(n,t){for(var e=[],i=1;i<n;i++){for(var o=[],r=0;r<t;r++){var a=Math.floor(8*Math.random());o.push(a)}e.push(o)}return e},update=function(n){kingsMan.sx==endPoint.x&&kingsMan.sy==endPoint.y&&(++stageNum,reset())},render=function(){ctx.fillStyle="#FFE6CD",ctx.fillRect(0,0,320,560),ctx.beginPath(),ctx.arc(kingsMan.x,kingsMan.y,20,0,2*Math.PI),ctx.fillStyle="#44B811",ctx.fill(),ctx.beginPath(),ctx.moveTo(40*(endPoint.x+1)-20,40*(endPoint.y+1)),ctx.lineTo(40*(endPoint.x+1),40*endPoint.y),ctx.lineTo(40*endPoint.x,40*endPoint.y),ctx.fillStyle="#F4AF29",ctx.fill(),ctx.fillStyle="rgb(0, 0, 0)",ctx.font="20px Helvetica",ctx.textAlign="left",ctx.textBaseline="top",ctx.fillText("Stage: "+stageNum,10,10),ctx.fillStyle="#2E1E1E",renderBlock(wallBlockArr)},renderMovePath=function(){var n=0;timer=setInterval(function(t){n<roadArr.length?(kingsMan.x=40*roadArr[n].x+20,kingsMan.y=40*roadArr[n].y+20,kingsMan.sx=roadArr[n].x,kingsMan.sy=roadArr[n].y,render()):(clearInterval(timer),isFinding=!1,initFindPath()),++n},150)},main=function(){var n=Date.now(),t=n-then;update(t/1e3),render(),then=n,requestAnimationFrame(main)},then=Date.now();reset(),main();