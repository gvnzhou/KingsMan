function $(n){return document.querySelector(n)}function $$(n){return document.querySelectorAll(n)}function renderBlock(n){n.forEach(function(n,t){var e=t+1;n.forEach(function(n,t){ctx.fillRect(n*block.width,e*block.height,block.width,block.height)})})}var isArrive,roadArr=[],openList=function(){var n=[];return{add:function(t){n.push(t)},count:function(){return n.length},minPoint:function(){return 1!==this.count()?(n.sort(compareF),n[0]):n[0]},removeAt:function(t){n.splice(t,1)},exists:function(t){for(i=0;i<n.length;i++)if(n[i].x==t.x&&n[i].y==t.y)return!0},foundPoint:function(n,t,e){},notFoundPoint:function(t,e,o){var i=!0,r=!0;if(wallBlockArr.forEach(function(n,t){n.forEach(function(n,e){n==o.x&&t+1==o.y&&(i=!1)})}),closeList.getCloseArr().forEach(function(n,t){n.x==o.x&&n.y==o.y&&(r=!1)}),r&&i){var a,c,s;c=10*(Math.abs(e.x-o.x)+Math.abs(e.y-o.y)),a=t.x===o.x||t.y===o.y?10:14,s=c+a,o.H=c,o.G=a,o.F=s,o.parents=t,n.push(o)}},get:function(n){closeList.getCloseArr().forEach(function(t,e){n.x===t.x&&n.y===t.y&&(n.parents=t.parents,isArrive=!0)})},look:function(){console.log(n)},init:function(){n.splice(0,n.length)}}}(),compareF=function(n,t){return n.F-t.F},closeList=function(){var n=[];return{add:function(t){n.push(t)},getCloseArr:function(){return n},init:function(){n.splice(0,n.length)}}}(),findPath=function(n,t){for(isArrive=!1,openList.add(n);0!==openList.count();){var e=openList.minPoint();openList.removeAt(0),closeList.add(e);var o=sAroundPoints(e);if(o.forEach(function(n,o){openList.exists(n)?openList.foundPoint(e,t,n):openList.notFoundPoint(e,t,n)}),openList.get(t),isArrive)break}foundPathRoad(t)},sAroundPoints=function(n){var t=n.x,e=n.y;return[{x:t-1,y:e},{x:t-1,y:e-1},{x:t-1,y:e+1},{x:t+1,y:e},{x:t+1,y:e-1},{x:t+1,y:e+1},{x:t,y:e-1},{x:t,y:e+1}]},foundPathRoad=function(n){return"parents"in n&&(roadArr.unshift(n),arguments.callee(n.parents)),roadArr},initFindPath=function(){roadArr.splice(0,roadArr.length),openList.init(),closeList.init()},eventUtil={addHandler:function(n,t,e){n.addEventListener?n.addEventListener(t,e,!1):n.attachEvent?n.attachEvent("on"+t,e):n["on"+t]=e},removeHandler:function(n,t,e){n.removeEventListener?n.removeEventListener(t,e,!1):n.detachEvent?n.detachEvent("on"+t,e):n["on"+t]=null}},canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");canvas.width=320,canvas.height=560,document.body.appendChild(canvas);var kingsMan={speed:256,x:180,y:20,sx:4,sy:0,flag:1},endPoint={x:3,y:13},block={width:40,height:40},cooX=[[0,40],[40,80],[80,120],[120,160],[160,200],[200,240],[240,280],[280,320]],cooY=[[0,40],[40,80],[80,120],[120,160],[160,200],[200,240],[240,280],[280,320],[320,360],[360,400],[400,440],[440,480],[480,520],[520,560]],wallBlockArr=[],stageNum=0,keysDown={},targetBlock;eventUtil.addHandler($("canvas"),"click",function(n){targetBlock=calTargetBlock(n.offsetX,n.offsetY),findPath({x:kingsMan.sx,y:kingsMan.sy,flag:kingsMan.flag},targetBlock),renderMovePath()},!1),eventUtil.addHandler(window,"keydown",function(n){keysDown[n.keyCode]=!0},!1),eventUtil.addHandler(window,"keyup",function(n){delete keysDown[n.keyCode]},!1);var calTargetBlock=function(n,t){var e,o,i={};return cooX.forEach(function(t,o){n>t[0]&&n<t[1]&&(e=o,i.x=e)}),cooY.forEach(function(n,e){t>n[0]&&t<n[1]&&(o=e,i.y=o)}),i},reset=function(){wallBlockArr=createBlock(13,2),kingsMan.x=180,kingsMan.y=20,kingsMan.sx=4,kingsMan.sy=0},createBlock=function(n,t){for(var e=[],o=1;n>o;o++){for(var i=[],r=0;t>r;r++){var a=Math.floor(8*Math.random());i.push(a)}e.push(i)}return e},update=function(n){38 in keysDown&&(kingsMan.y-=kingsMan.speed*n),40 in keysDown&&(kingsMan.y+=kingsMan.speed*n),37 in keysDown&&(kingsMan.x-=kingsMan.speed*n),39 in keysDown&&(kingsMan.x+=kingsMan.speed*n),kingsMan.sx==endPoint.x&&kingsMan.sy==endPoint.y&&(++stageNum,reset())},render=function(){ctx.fillStyle="#FFE6CD",ctx.fillRect(0,0,320,560),ctx.beginPath(),ctx.arc(kingsMan.x,kingsMan.y,20,0,2*Math.PI),ctx.fillStyle="#44B811",ctx.fill(),ctx.beginPath(),ctx.moveTo(40*(endPoint.x+1)-20,40*(endPoint.y+1)),ctx.lineTo(40*(endPoint.x+1),40*endPoint.y),ctx.lineTo(40*endPoint.x,40*endPoint.y),ctx.fillStyle="#F4AF29",ctx.fill(),ctx.fillStyle="rgb(0, 0, 0)",ctx.font="20px Helvetica",ctx.textAlign="left",ctx.textBaseline="top",ctx.fillText("Stage: "+stageNum,10,10),ctx.fillStyle="#2E1E1E",renderBlock(wallBlockArr)},renderMovePath=function(){var n=0;timer=setInterval(function(t){n<roadArr.length?(kingsMan.x=40*roadArr[n].x+20,kingsMan.y=40*roadArr[n].y+20,kingsMan.sx=roadArr[n].x,kingsMan.sy=roadArr[n].y,render()):(clearInterval(timer),initFindPath()),++n},150)},main=function(){var n=Date.now(),t=n-then;update(t/1e3),render(),then=n,requestAnimationFrame(main)},then=Date.now();reset(),main();